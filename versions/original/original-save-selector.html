<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#800000">
  <meta name="description" content="An original game created with RPG Maker (PSX), and made playable in the browser by EmulatorJS. Select game save.">
  <title>NSK Warrior OG Save Selector</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/images/192x192.png">
  <link rel="icon" href="/favicon.ico">
  
  <style>
    body,
    html {
      height: 100%;
      background-color: black;
      color: white;
    }
    
    body {
      margin: 0;
      overflow: hidden;
      padding-top: env(safe-area-inset-top);
    }
    
    .container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      height: 100%;
      overflow: hidden;
      padding-top: 2em;
      box-sizing: border-box;
    }
    
    h1 {
      font-family: Avenir, "Avenir Next", "Helvetica Neue", "Segoe UI", Helvetica, Arial, sans-serif;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
      font-size: 20px;
      line-height: 45px;
      text-transform: uppercase;
      font-weight: bolder;
    }
    
    .button_container {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      flex-direction: row;
      width: 100%;
      max-width: 100vw;
      gap: 20px;
    }
    
    .save-slot {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 180px;
      max-width: 50%;
    }
    
    img {
      width: 100%;
      height: 120px;
      border-radius: 8px;
      object-fit: cover;
    }
    
    .timestamp {
      position: absolute;
      bottom: 65px;
      left: 0;
      width: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      font-family: sans-serif;
      font-size: 12px;
      text-align: center;
      padding: 4px 0;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
      pointer-events: none;
    }
    
    .select_button {
      position: relative;
      outline: none;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
      box-sizing: inherit;
      display: flex;
      justify-content: center;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
      font-size: 20px;
      line-height: 45px;
      text-transform: uppercase;
      font-weight: bolder;
      margin: .5em;
      text-decoration: none;
      width: fit-content;
      padding-left: 30px;
      padding-right: 30px;
      white-space: nowrap;
      height: 45px;
      border: 0;
      color: #fff !important;
      border-radius: 35px;
      text-align: center;
      background-color: #800000;
      box-shadow: 0 0 0 0 #222, 0 0px 0px 0 #111, inset 0 0px 0px 0 rgba(250, 250, 250, 0.2), inset 0 0px 0px 0px rgba(0, 0, 0, 0.5);
    }
    
    .select_button_border {
      border: 0.5px solid #333;
    }
    
    .select_button:active,
    .select_button:hover {
      animation: select_button_pulse 2s infinite;
    }
    
    @keyframes select_button_pulse {
      50% {
        box-shadow: 0 0 0 0 #222, 0 3px 7px 0 #111, inset 0 1px 1px 0 rgba(250, 250, 250, 0.2), inset 0 0px 15px 1px rgba(0, 0, 0, 0.5);
      }
      
      0%,
      100% {
        box-shadow: 0 0 0 0 #222, 0 0px 0px 0 #111, inset 0 0px 0px 0 rgba(250, 250, 250, 0.2), inset 0 0px 0px 0px rgba(0, 0, 0, 0.5);
      }
    }
  </style>
  
</head>

<body>
  
  <script src="../../scripts/screenshot-handler.js"></script>
  
  <script>
    const saveSlots = [
      { key: "NSK_WARRIOR_OG_1", imgId: "slot-1-img", timeId: "slot-1-time" },
      { key: "NSK_WARRIOR_OG_2", imgId: "slot-2-img", timeId: "slot-2-time" },
      { key: "NSK_WARRIOR_OG_3", imgId: "slot-3-img", timeId: "slot-3-time" },
      { key: "NSK_WARRIOR_OG_4", imgId: "slot-4-img", timeId: "slot-4-time" },
    ];
    
    let activeObjectUrls = [];
    
    async function loadAllScreenshots() {
      activeObjectUrls.forEach(url => URL.revokeObjectURL(url));
      activeObjectUrls = [];
      
      for (const slot of saveSlots) {
        const imgElement = document.getElementById(slot.imgId);
        const timeElement = document.getElementById(slot.timeId);
        
        if (!imgElement) continue;
        
        try {
          const record = await loadScreenshot(slot.key);
          
          let blob = null;
          let timestamp = null;
          
          if (record instanceof Blob) {
            // Handle old format (just a blob, no time)
            blob = record;
          } else if (record && record.image) {
            // Handle new format
            blob = record.image;
            timestamp = record.created;
          }
          
          if (blob) {
            const imageUrl = URL.createObjectURL(blob);
            activeObjectUrls.push(imageUrl);
            imgElement.src = imageUrl;
            
            if (timestamp && timeElement) {
              timeElement.textContent = timestamp;
            }
          } else {
            imgElement.src = "../../images/save-placeholder.png";
          }
          
        } catch (error) {
          console.error(`Error loading slot ${slot.key}:`, error);
          imgElement.src = "../../images/save-placeholder.png";
          if (timeElement) timeElement.innerText = "ERROR!";
        }
      }
    };
    
    document.addEventListener("DOMContentLoaded", () => {
      loadAllScreenshots();
    });
    
    window.addEventListener("pageshow", (event) => {
      if (event.persisted) {
        console.log("Page restored from bfcache. Forcing screenshot refresh.");
        loadAllScreenshots();
      }
    });
    
    window.addEventListener("beforeunload", () => {
      activeObjectUrls.forEach(url => URL.revokeObjectURL(url));
    });
  </script>
  
  <div class="container" id="container">
    <h1>original version</h1>
    <div class="button_container">
      <div class="save-slot">
        <img id="slot-1-img" src="../../images/save-placeholder.png">
        <span id="slot-1-time" class="timestamp">EMPTY</span>
        <button class="select_button" id="slot-1" onclick="window.location.href='/versions/original/og-save-1.html';">save slot 1</button>
      </div>
      
      <div class="save-slot">
        <img id="slot-2-img" src="../../images/save-placeholder.png">
        <span id="slot-2-time" class="timestamp">EMPTY</span>
        <button class="select_button" id="slot-2" onclick="window.location.href='/versions/original/og-save-2.html';">save slot 2</button>
      </div>
      
      <div class="save-slot">
        <img id="slot-3-img" src="../../images/save-placeholder.png">
        <span id="slot-3-time" class="timestamp">EMPTY</span>
        <button class="select_button" id="slot-3" onclick="window.location.href='/versions/original/og-save-3.html';">save slot 3</button>
      </div>
      
      <div class="save-slot">
        <img id="slot-4-img" src="../../images/save-placeholder.png">
        <span id="slot-4-time" class="timestamp">EMPTY</span>
        <button class="select_button" id="slot-4" onclick="window.location.href='/versions/original/og-save-4.html';">save slot 4</button>
      </div>
    </div>
  </div>
  
  <script>
  (async function initMigration() {
    
    const DB_NAME = 'EmulatorJS-states'; 
    const STORE_NAME = 'states';
    const KEYS_LIST_ID = '?EJS_KEYS!'; 
    
    const TARGET_PREFIX = 'NSK_WARRIOR_OG'; 
    const LEGACY_SAVES = [
      'NSK WARRIOR.state'
    ];

    // Helper: Open DB
    const openDB = () => {
      return new Promise((resolve) => {
        const req = indexedDB.open(DB_NAME);
        req.onerror = () => resolve(null); // Fail silently if DB doesn't exist
        req.onsuccess = () => resolve(req.result);
      });
    };

    // Helper: Get data (Generic)
    const getData = (db, key) => {
      return new Promise((resolve) => {
        const tx = db.transaction([STORE_NAME], 'readonly');
        const req = tx.objectStore(STORE_NAME).get(key);
        req.onsuccess = () => resolve(req.result !== undefined ? req.result : null);
        req.onerror = () => resolve(null);
      });
    };

    try {
      const db = await openDB();
      // Verify DB and Store exist
      if (!db || !db.objectStoreNames.contains(STORE_NAME)) {
          console.log(`Database ${DB_NAME} or store ${STORE_NAME} not found.`);
          return;
      }

      // 1. Find a legacy file
      let legacyData = null;
      let legacyName = null;

      for (const oldName of LEGACY_SAVES) {
        const data = await getData(db, oldName);
        if (data) {
          legacyData = data;
          legacyName = oldName;
          console.log("Found legacy save:", legacyName);
          break; 
        }
      }

      if (!legacyData) return; // No old saves found, exit.

      // 2. Find the first EMPTY slot in the new system (1-4)
      let targetSlot = null;
      let targetKey = null;

      for (let i = 1; i <= 4; i++) {
        const key = `${TARGET_PREFIX}_${i}.state`;
        const existingData = await getData(db, key);
        if (!existingData) {
          targetSlot = i;
          targetKey = key;
          break; // Found empty slot
        }
      }

      // 3. Update UI
      if (targetSlot && legacyData) {
        const btnId = `slot-${targetSlot}`;
        const btn = document.getElementById(btnId);
        const time = document.getElementById(`${btnId}-time`);

        if (btn) {
          // Visuals
          btn.innerText = "IMPORT OLD SAVE";
          btn.style.backgroundColor = "#d35400"; 
          btn.style.border = "2px solid white";
          btn.style.animation = "select_button_pulse 1s infinite"; // Faster pulse
          
          if(time) time.innerText = "Legacy Save Found";

          // Action
          btn.onclick = async (e) => {
            e.preventDefault();
            e.stopPropagation();

            if(!confirm(`Found old save: "${legacyName}".\nImport it to Slot ${targetSlot}?`)) return;

            const tx = db.transaction([STORE_NAME], 'readwrite');
            const store = tx.objectStore(STORE_NAME);

            // A. Get Master Key List
            const keysReq = store.get(KEYS_LIST_ID);
            
            keysReq.onsuccess = () => {
              let keys = keysReq.result || [];
              
              // B. Update Key List (Remove Old, Add New)
              const oldIndex = keys.indexOf(legacyName);
              if (oldIndex > -1) keys.splice(oldIndex, 1);
              if (!keys.includes(targetKey)) keys.push(targetKey);

              // C. Move .state File
              store.put(keys, KEYS_LIST_ID); 
              store.put(legacyData, targetKey); 
              store.delete(legacyName); 

              // D. Move Screenshot (.png)
              // We assume screenshots live in the same store with .png appended
              const oldScreenKey = legacyName + '.png';
              const newScreenKey = targetKey + '.png';
              
              const screenReq = store.get(oldScreenKey);
              screenReq.onsuccess = () => {
                  if (screenReq.result) {
                      store.put(screenReq.result, newScreenKey);
                      store.delete(oldScreenKey);
                      
                      // Update keys list for screenshot
                      if (!keys.includes(newScreenKey)) keys.push(newScreenKey);
                      const scrIndex = keys.indexOf(oldScreenKey);
                      if (scrIndex > -1) keys.splice(scrIndex, 1);
                      store.put(keys, KEYS_LIST_ID); 
                  }
              };
            };

            tx.oncomplete = () => {
              alert("Save migrated successfully!");
              window.location.reload();
            };
            
            tx.onerror = (err) => {
              console.error(err);
              alert("Error importing save.");
            }
          };
        }
      }

    } catch (err) {
      console.error("Auto-migration check failed:", err);
    }

  })();
</script>
  
</body>

</html>
